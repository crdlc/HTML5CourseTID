<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <title>Custom elements</title>
    <script src="mini-templates.js"></script>
  </head>

  <body>
    <x-list id="my-list">
      <template>
        <li><a href="#"><strong>#text#</strong></a></li>
      </template>
    </x-list>

    <button type=button onclick="loadData()">Load Data</button>
    <button type=button onclick="appendData()">Append Data</button>
    <button type=button onclick="removeLast()">Remove Last</button>

    <template id="x-list-template">
      <link rel="stylesheet" href="lists.css">

      <section data-type="list">
        <header>List</header>
        <ul>
          <content></content>
        </ul>
      </section>
    </template>
  </body>

  <script>
    var xListProto = Object.create(HTMLElement.prototype);

    // Setting the data
    Object.defineProperty(xListProto, 'ref', {
      set: function(data) {
        this.clear();

        var container = this.shadowRoot.querySelector('ul');
        var template = container.
                          querySelector('content').getDistributedNodes()[1];

        data.forEach(function(aItem) {
          Templates.append(container, aItem, template);
        }, this);

        this.numItems = data.length;
      }
    });

    xListProto.append = function(itemData) {
      var container = this.shadowRoot.querySelector('ul');
      var template = container.
                          querySelector('content').getDistributedNodes()[1];

      Templates.append(container, itemData, template);

      this.numItems = this.numItems || 0;
      this.numItems++;
    };

    xListProto.item = function(indexOrId) {
      var selector;
      if (typeof indexOrId === 'string') {
        selector = '#' + indexOrId;
      }
      else {
        selector = 'li:nth-child(' + (indexOrId + 1) + ')';
      }

      return this.shadowRoot.querySelector('ul').querySelector(selector);
    };

    xListProto.remove = function(indexOrId) {
      var item = this.item(indexOrId);

      if (!item) {
        return;
      }

      this.shadowRoot.querySelector('ul').removeChild(item);

      this.numItems--;
    };

    xListProto.clear = function() {
      this.shadowRoot.querySelector('ul').innerHTML = '<content></content>';
      this.numItems = 0;
    };

    xListProto.createdCallback = function() {
      var shadow = this.createShadowRoot();

      var listTemplate = document.getElementById('x-list-template');
      var node = document.importNode(listTemplate.content, true);
      shadow.appendChild(node);

      var link = shadow.querySelector('link');
      var component = this;

      if (link) {
        var resource = link.href;
        var xhr = new XMLHttpRequest();

        xhr.open('GET', resource);

        xhr.onload = function() {
          shadow.innerHTML += ('<style>' + xhr.responseText + '</style>');

          shadow.querySelector('ul').addEventListener('click', function(e) {
            var id = e.target.id || e.target.parentNode.id;
            component.selectedItem = id;
          });
        }

        xhr.onerror = function() {
          alert('error');
        }

        xhr.send(null);
      }
    };

    var XList = document.registerElement('x-list', {
      prototype: xListProto
    });
  </script>

  <script>
    var myList = document.getElementById('my-list');

    myList.addEventListener('click', function(e) {
      console.log('Element clicked: ', e.target.selectedItem);
    });

    var nextId = 3;

    function loadData() {
      var dataList = [
        {
          id: 'l1',
          text: 'Text of element 1'
        },
        {
          id: 'l2',
          text: 'Text of element 2'
        }
      ];
      myList.ref = dataList;
    }

    function appendData() {
      myList.append({
        id: 'l' + nextId,
        text: 'Appended Text: ' + nextId++
      });
    }

    function removeLast() {
      console.log('Num Items: ', myList.numItems);
      myList.remove(myList.numItems);
    }
  </script>
</html>
